<script context="module"></script>

<script generics="T extends Record<string, unknown>, U extends FormPathLeaves<T>">import { getValueAtPath } from "../internal/utils/path.js";
import { setFormField, getFormField } from "../context.js";
import { writable } from "svelte/store";
import { extractErrorArray } from "../internal/utils/index.js";
export let form;
export let name;
$:
  ({
    errors: formErrors,
    constraints: formConstraints,
    tainted: formTainted,
    form: formData
  } = form);
const { descriptionId: parentDescriptionId } = getFormField();
$:
  [path] = splitArrayPath(name);
const elementField = {
  name: writable(path),
  errors: writable([]),
  constraints: writable({}),
  tainted: writable(false),
  fieldErrorsId: writable(),
  descriptionId: writable($parentDescriptionId),
  form
};
const { tainted, errors, descriptionId } = elementField;
function splitArrayPath(name2) {
  const [path2, index] = name2.split(/[[\]]/);
  return [path2, index];
}
$:
  elementField.name.set(path);
$:
  errors.set(extractErrorArray(getValueAtPath(name, $formErrors)));
$:
  elementField.constraints.set(getValueAtPath(name, $formConstraints) ?? {});
$:
  tainted.set(
    $formTainted ? getValueAtPath(name, $formTainted) === true ? true : false : false
  );
$:
  if (!$descriptionId && $parentDescriptionId) {
    elementField.descriptionId.set($parentDescriptionId);
  }
setFormField(elementField);
$:
  value = getValueAtPath(name, $formData);
</script>

<!--
@component
## ElementField
A component that provides the necessary context for a form field that represents a single element in an array.

- [ElementField Documentation](https://formsnap.dev/docs/components/element-field)

### Slot Props
- `value` - The value of the field.
- `errors` - The errors of the field.
- `tainted` - The tainted state of the field.
- `constraints` - The constraints of the field.

@param {SuperForm} form - The form object.
@param {FormPathLeaves<T>} name - The name and index of the field. For example, `urls[0]`.
-->

<slot {value} errors={$errors} tainted={$tainted} constraints={$formConstraints[name]} />
